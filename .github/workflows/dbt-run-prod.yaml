---
name: DBT Run prod
on:
  pull_request:
    types: [closed]
jobs:
  dbt-run-prod:
    if: contains(github.event.pull_request.labels.*.name, 'table-approve')
    name: DBT Run prod
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Get all changed files using a comma separator
        id: changed-files
        uses: tj-actions/changed-files@6cb76d07bee4c9772c6882c06c37837bf82a04d3  # v46
        with:
          separator: ','
      - name: Set up poetry
        run: pipx install poetry==1.8.5
      - name: Set up python
        uses: actions/setup-python@v4
        with:
          cache: poetry
          python-version: '3.10'
      - name: Install requirements
        run: poetry install --without dev --no-root
      - name: Run script to materialize DBT model in production
        run: |-
          poetry run python .github/workflows/scripts/dbt_run.py \
            --target prod \
            --dbt-command run \
            --modified-files ${{ steps.changed-files.outputs.all_modified_files }} \
            --graphql-url ${{ secrets.BACKEND_GRAPHQL_URL }} \
            --source-bucket-name ${{ secrets.SOURCE_BUCKET_NAME }} \
            --destination-bucket-name ${{ secrets.DESTINATION_BUCKET_NAME }} \
            --backup-bucket-name ${{ secrets.BACKUP_BUCKET_NAME }}
