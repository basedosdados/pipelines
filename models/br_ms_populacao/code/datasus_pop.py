"""datasus pop

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1hsHGX_-FIHWqwR3nAcMZeTfnTBmzH7BW
"""

import ftplib
import io
import os
import tempfile
import zipfile

import basedosdados as bd
import pandas as pd
from databasers_utils import TableArchitecture
from dbfread import DBF

FTP_HOST = "ftp.datasus.gov.br"
FTP_PATH = "/dissemin/publicos/IBGE/POPSVS/"
ENCODING = "latin1"
BASE_PATH = "br_ms_populacao/output"


def resgata_arquivo(ano):
    ftp = ftplib.FTP(FTP_HOST)
    ftp.login()
    ftp.cwd(FTP_PATH)

    zip_filename = f"POPSBR{ano}.zip"
    zip_bytes = io.BytesIO()
    ftp.retrbinary(f"RETR {zip_filename}", zip_bytes.write)
    ftp.quit()

    #  lê o zip
    zip_bytes.seek(0)
    with zipfile.ZipFile(zip_bytes) as z:
        # pega o .dbf
        dbf_filename = next(
            name for name in z.namelist() if name.lower().endswith(".dbf")
        )

        # extrai o .dbf para arquivo temporário
        with tempfile.NamedTemporaryFile(
            delete=False, suffix=".dbf"
        ) as temp_dbf:
            temp_dbf.write(z.read(dbf_filename))
            temp_dbf_path = temp_dbf.name

    # lê .dbf usando dbfread
    dbf_data = DBF(
        temp_dbf_path, encoding=ENCODING
    )  # tente 'cp1252' se necessário
    dados = pd.DataFrame(iter(dbf_data))
    return dados


def organiza_dados(dados):
    dados.columns = ["id_municipio", "ano", "sexo", "idade", "populacao"]
    dados = dados[["ano", "id_municipio", "sexo", "idade", "populacao"]]
    dados["sexo"] = (
        dados["sexo"].astype("int").replace({1: "masculino", 2: "feminino"})
    )

    # Passo 1: Converter a idade para inteiro
    dados["idade_int"] = dados["idade"].astype(int)

    # Passo 2: Criar a faixa etária de 5 em 5 anos
    # Ex: 0-4, 5-9, ..., 75-79, 80+
    def faixa_etaria(idade):
        if idade >= 80:
            return "80-mais"
        else:
            faixa_inicio = (idade // 5) * 5
            faixa_fim = faixa_inicio + 4
            return f"{faixa_inicio}-{faixa_fim} anos"

    dados["grupo_idade"] = dados["idade_int"].apply(faixa_etaria)

    # Passo 3: Agrupar por cidade, sexo e faixa etária
    dados_agrupado = dados.groupby(
        ["ano", "id_municipio", "sexo", "grupo_idade"], as_index=False
    )["populacao"].sum()
    return dados_agrupado


dados = pd.DataFrame()
anos = [
    "00",
    "01",
    "02",
    "03",
    "04",
    "05",
    "06",
    "07",
    "08",
    "09",
    "10",
    "11",
    "12",
    "13",
    "14",
    "15",
    "16",
    "17",
    "18",
    "19",
    "20",
    "21",
    "22",
    "23",
    "24",
]
for ano in anos:
    dados = resgata_arquivo(ano)
    dados_agrupado = organiza_dados(dados)
    dados = pd.concat([dados, dados_agrupado])

dados["ano"] = dados.ano.astype("int")
dados["id_municipio"] = dados.id_municipio.astype("int")

# dados_canaa = dados[dados['id_municipio']==1502152]
# dados_canaa.to_csv('populacao_canaa.csv',index=False)

dados.to_csv("populacao_ms.csv", index=False)

# dados[dados['ano']>2020].to_csv('dados_desde_2021.csv',index=False)

# Particionamento
for ano, dados_ano in dados[dados["ano"] >= 2022].groupby("ano"):
    pasta_ano = os.path.join(BASE_PATH, f"ano={ano}")
    os.makedirs(pasta_ano, exist_ok=True)

    nome_arquivo = f"br_ms_populacao_{ano}.csv"

    dados_ano = dados_ano.assign(
        ano=dados_ano["ano"].astype("int64"),
        id_municipio=dados_ano["id_municipio"].astype("string"),
        sexo=dados_ano["sexo"].astype("string"),
        grupo_idade=dados_ano["grupo_idade"].astype("string"),
        populacao=dados_ano["populacao"].astype("int64"),
    )

    dados_ano = dados_ano[["id_municipio", "sexo", "grupo_idade", "populacao"]]

    dados_ano.to_csv(
        os.path.join(pasta_ano, nome_arquivo), index=False, sep=","
    )

# Subir na BD
tb = bd.Table(dataset_id="br_ms_populacao", table_id="municipio")

tb.create(
    path="/br_ms_populacao/output",
    if_table_exists="raise",
    if_storage_data_exists="raise",
    source_format="csv",
)

# Criar arquivos DBT
arch = TableArchitecture(
    dataset_id="br_ms_populacao",
    tables={
        "municipio": "https://docs.google.com/spreadsheets/d/128nZetUtAXoE0PgIc0nb9rcBGqm5U_Wg/edit?usp=sharing&ouid=117308588429558922267&rtpof=true&sd=true",
    },
)

# Cria o yaml file
arch.create_yaml_file()

# Cria os arquivos sql
arch.create_sql_files()

# Atualiza o dbt_project.yml
arch.update_dbt_project()

# Faz o upload das colunas para o DJango
# Para essa etapa é necessário ter duas varíaveis de ambiente configurada
# BD_DJANGO_EMAIL="seuemail@basedosdados.org"
# BD_DJANGO_PASSWORD="password"
# arch.upload_columns()
