{{
    config(
        alias="microdados",
        schema="br_ibge_pnadc",
        materialized="table",
        partition_by={
            "field": "ano",
            "data_type": "int64",
            "range": {"start": 2012, "end": 2025, "interval": 1},
        },
        cluster_by="sigla_uf",
        labels={"tema": "economia"},
    )
}}
{%- set columns = adapter.get_columns_in_relation(this) -%}
with
    microdados as (
        select
            safe_cast(ano as int64) ano,
            safe_cast(trimestre as int64) trimestre,
            safe_cast(id_uf as string) id_uf,
            safe_cast(sigla_uf as string) sigla_uf,
            safe_cast(capital as string) capital,
            safe_cast(rm_ride as string) rm_ride,
            safe_cast(id_upa as string) id_upa,
            safe_cast(id_estrato as string) id_estrato,
            safe_cast(
                concat(id_upa, lpad(v1008, 2, '0'), lpad(v1014, 2, '0')) as string
            ) id_domicilio,
            safe_cast(
                concat(
                    id_upa,
                    lpad(v1008, 2, '0'),
                    lpad(v1014, 2, '0'),
                    lpad(v2003, 2, '0')
                ) as string
            ) id_pessoa,
            safe_cast(lpad(v1008, 2, '0') as string) v1008,
            safe_cast(lpad(v1014, 2, '0') as string) v1014,
            safe_cast(v1016 as int64) v1016,
            safe_cast(v1022 as string) v1022,
            safe_cast(v1023 as string) v1023,
            safe_cast(v1027 as float64) v1027,
            safe_cast(v1028 as float64) v1028,
            safe_cast(v1029 as int64) v1029,
            safe_cast(v1033 as int64) v1033,
            safe_cast(posest as string) posest,
            safe_cast(posest_sxi as string) posest_sxi,
            safe_cast(v2001 as int64) v2001,
            safe_cast(v2003 as int64) v2003,
            safe_cast(v2005 as string) v2005,
            safe_cast(v2007 as string) v2007,
            safe_cast(v2008 as int64) v2008,
            safe_cast(v20081 as int64) v20081,
            safe_cast(v20082 as int64) v20082,
            safe_cast(v2009 as int64) v2009,
            safe_cast(v2010 as string) v2010,
            safe_cast(v3001 as string) v3001,
            safe_cast(v3002 as string) v3002,
            safe_cast(v3002a as string) v3002a,
            safe_cast(v3003 as string) v3003,
            safe_cast(v3003a as string) v3003a,
            safe_cast(v3004 as string) v3004,
            safe_cast(v3005 as string) v3005,
            safe_cast(v3005a as string) v3005a,
            safe_cast(v3006 as string) v3006,
            safe_cast(v3006a as string) v3006a,
            safe_cast(v3007 as string) v3007,
            safe_cast(v3008 as string) v3008,
            safe_cast(v3009 as string) v3009,
            safe_cast(v3009a as string) v3009a,
            safe_cast(v3010 as string) v3010,
            safe_cast(v3011 as string) v3011,
            safe_cast(v3011a as string) v3011a,
            safe_cast(v3012 as string) v3012,
            safe_cast(v3013 as string) v3013,
            safe_cast(v3013a as string) v3013a,
            safe_cast(v3013b as string) v3013b,
            safe_cast(v3014 as string) v3014,
            safe_cast(v4001 as string) v4001,
            safe_cast(v4002 as string) v4002,
            safe_cast(v4003 as string) v4003,
            safe_cast(v4004 as string) v4004,
            safe_cast(v4005 as string) v4005,
            safe_cast(v4006 as string) v4006,
            safe_cast(v4006a as string) v4006a,
            safe_cast(v4007 as string) v4007,
            safe_cast(v4008 as string) v4008,
            safe_cast(v40081 as int64) v40081,
            safe_cast(v40082 as int64) v40082,
            safe_cast(v40083 as int64) v40083,
            safe_cast(v4009 as string) v4009,
            safe_cast(v4010 as string) v4010,
            safe_cast(v4012 as string) v4012,
            safe_cast(v40121 as string) v40121,
            safe_cast(v4013 as string) v4013,
            safe_cast(v40132 as string) v40132,
            safe_cast(v40132a as string) v40132a,
            safe_cast(v4014 as string) v4014,
            safe_cast(v4015 as string) v4015,
            safe_cast(v40151 as string) v40151,
            safe_cast(v401511 as int64) v401511,
            safe_cast(v401512 as int64) v401512,
            safe_cast(v4016 as string) v4016,
            safe_cast(v40161 as int64) v40161,
            safe_cast(v40162 as int64) v40162,
            safe_cast(v40163 as int64) v40163,
            safe_cast(v4017 as string) v4017,
            safe_cast(v40171 as string) v40171,
            safe_cast(v401711 as int64) v401711,
            safe_cast(v4018 as string) v4018,
            safe_cast(v40181 as int64) v40181,
            safe_cast(v40182 as int64) v40182,
            safe_cast(v40183 as int64) v40183,
            safe_cast(v4019 as string) v4019,
            safe_cast(v4020 as string) v4020,
            safe_cast(v4021 as string) v4021,
            safe_cast(v4022 as string) v4022,
            safe_cast(v4024 as string) v4024,
            safe_cast(v4025 as string) v4025,
            safe_cast(v4026 as string) v4026,
            safe_cast(v4027 as string) v4027,
            safe_cast(v4028 as string) v4028,
            safe_cast(v4029 as string) v4029,
            safe_cast(v4032 as string) v4032,
            safe_cast(v4033 as string) v4033,
            safe_cast(v40331 as string) v40331,
            safe_cast(v403311 as string) v403311,
            safe_cast(v403312 as float64) v403312,
            safe_cast(v40332 as string) v40332,
            safe_cast(v403321 as string) v403321,
            safe_cast(v403322 as float64) v403322,
            safe_cast(v40333 as string) v40333,
            safe_cast(v403331 as string) v403331,
            safe_cast(v4034 as string) v4034,
            safe_cast(v40341 as string) v40341,
            safe_cast(v403411 as string) v403411,
            safe_cast(v403412 as float64) v403412,
            safe_cast(v40342 as string) v40342,
            safe_cast(v403421 as string) v403421,
            safe_cast(v403422 as float64) v403422,
            safe_cast(v4039 as int64) v4039,
            safe_cast(v4039c as int64) v4039c,
            safe_cast(v4040 as string) v4040,
            safe_cast(v40401 as string) v40401,
            safe_cast(v40402 as string) v40402,
            safe_cast(v40403 as string) v40403,
            safe_cast(v4041 as string) v4041,
            safe_cast(v4043 as string) v4043,
            safe_cast(v40431 as string) v40431,
            safe_cast(v4044 as string) v4044,
            safe_cast(v4045 as string) v4045,
            safe_cast(v4046 as string) v4046,
            safe_cast(v4047 as string) v4047,
            safe_cast(v4048 as string) v4048,
            safe_cast(v4049 as string) v4049,
            safe_cast(v4050 as string) v4050,
            safe_cast(v40501 as string) v40501,
            safe_cast(v405011 as string) v405011,
            safe_cast(v405012 as float64) v405012,
            safe_cast(v40502 as string) v40502,
            safe_cast(v405021 as string) v405021,
            safe_cast(v405022 as float64) v405022,
            safe_cast(v40503 as string) v40503,
            safe_cast(v405031 as string) v405031,
            safe_cast(v4051 as string) v4051,
            safe_cast(v40511 as string) v40511,
            safe_cast(v405111 as string) v405111,
            safe_cast(v405112 as float64) v405112,
            safe_cast(v40512 as string) v40512,
            safe_cast(v405121 as string) v405121,
            safe_cast(v405122 as float64) v405122,
            safe_cast(v4056 as int64) v4056,
            safe_cast(v4056c as int64) v4056c,
            safe_cast(v4057 as string) v4057,
            safe_cast(v4058 as string) v4058,
            safe_cast(v40581 as string) v40581,
            safe_cast(v405811 as string) v405811,
            safe_cast(v405812 as float64) v405812,
            safe_cast(v40582 as string) v40582,
            safe_cast(v405821 as string) v405821,
            safe_cast(v405822 as float64) v405822,
            safe_cast(v40583 as string) v40583,
            safe_cast(v405831 as string) v405831,
            safe_cast(v40584 as string) v40584,
            safe_cast(v4059 as string) v4059,
            safe_cast(v40591 as string) v40591,
            safe_cast(v405911 as string) v405911,
            safe_cast(v405912 as float64) v405912,
            safe_cast(v40592 as string) v40592,
            safe_cast(v405921 as string) v405921,
            safe_cast(v405922 as float64) v405922,
            safe_cast(v4062 as int64) v4062,
            safe_cast(v4062c as int64) v4062c,
            safe_cast(v4063 as string) v4063,
            safe_cast(v4063a as string) v4063a,
            safe_cast(v4064 as string) v4064,
            safe_cast(v4064a as string) v4064a,
            safe_cast(v4071 as string) v4071,
            safe_cast(v4072 as string) v4072,
            safe_cast(v4072a as string) v4072a,
            safe_cast(v4073 as string) v4073,
            safe_cast(v4074 as string) v4074,
            safe_cast(v4074a as string) v4074a,
            safe_cast(v4075a as string) v4075a,
            safe_cast(v4075a1 as int64) v4075a1,
            safe_cast(v4076 as string) v4076,
            safe_cast(v40761 as int64) v40761,
            safe_cast(v40762 as int64) v40762,
            safe_cast(v40763 as int64) v40763,
            safe_cast(v4077 as string) v4077,
            safe_cast(v4078 as string) v4078,
            safe_cast(v4078a as string) v4078a,
            safe_cast(v4082 as string) v4082,
            safe_cast(vd2002 as string) vd2002,
            safe_cast(vd2003 as int64) vd2003,
            safe_cast(vd2004 as string) vd2004,
            safe_cast(vd3004 as string) vd3004,
            safe_cast(vd3005 as int64) vd3005,
            safe_cast(vd3006 as string) vd3006,
            safe_cast(vd4001 as string) vd4001,
            safe_cast(vd4002 as string) vd4002,
            safe_cast(vd4003 as string) vd4003,
            safe_cast(vd4004 as string) vd4004,
            safe_cast(vd4004a as string) vd4004a,
            safe_cast(vd4005 as string) vd4005,
            safe_cast(vd4007 as string) vd4007,
            safe_cast(vd4008 as string) vd4008,
            safe_cast(vd4009 as string) vd4009,
            safe_cast(vd4010 as string) vd4010,
            safe_cast(vd4011 as string) vd4011,
            safe_cast(vd4012 as string) vd4012,
            safe_cast(vd4013 as string) vd4013,
            safe_cast(vd4014 as string) vd4014,
            safe_cast(vd4015 as string) vd4015,
            safe_cast(vd4016 as float64) vd4016,
            safe_cast(vd4017 as float64) vd4017,
            safe_cast(vd4018 as string) vd4018,
            safe_cast(vd4019 as float64) vd4019,
            safe_cast(vd4020 as float64) vd4020,
            safe_cast(vd4023 as string) vd4023,
            safe_cast(vd4030 as string) vd4030,
            safe_cast(vd4031 as int64) vd4031,
            safe_cast(vd4032 as int64) vd4032,
            safe_cast(vd4033 as int64) vd4033,
            safe_cast(vd4034 as int64) vd4034,
            safe_cast(vd4035 as int64) vd4035,
            safe_cast(vd4036 as string) vd4036,
            safe_cast(vd4037 as string) vd4037,
            safe_cast(v1028001 as float64) v1028001,
            safe_cast(v1028002 as float64) v1028002,
            safe_cast(v1028003 as float64) v1028003,
            safe_cast(v1028004 as float64) v1028004,
            safe_cast(v1028005 as float64) v1028005,
            safe_cast(v1028006 as float64) v1028006,
            safe_cast(v1028007 as float64) v1028007,
            safe_cast(v1028008 as float64) v1028008,
            safe_cast(v1028009 as float64) v1028009,
            safe_cast(v1028010 as float64) v1028010,
            safe_cast(v1028011 as float64) v1028011,
            safe_cast(v1028012 as float64) v1028012,
            safe_cast(v1028013 as float64) v1028013,
            safe_cast(v1028014 as float64) v1028014,
            safe_cast(v1028015 as float64) v1028015,
            safe_cast(v1028016 as float64) v1028016,
            safe_cast(v1028017 as float64) v1028017,
            safe_cast(v1028018 as float64) v1028018,
            safe_cast(v1028019 as float64) v1028019,
            safe_cast(v1028020 as float64) v1028020,
            safe_cast(v1028021 as float64) v1028021,
            safe_cast(v1028022 as float64) v1028022,
            safe_cast(v1028023 as float64) v1028023,
            safe_cast(v1028024 as float64) v1028024,
            safe_cast(v1028025 as float64) v1028025,
            safe_cast(v1028026 as float64) v1028026,
            safe_cast(v1028027 as float64) v1028027,
            safe_cast(v1028028 as float64) v1028028,
            safe_cast(v1028029 as float64) v1028029,
            safe_cast(v1028030 as float64) v1028030,
            safe_cast(v1028031 as float64) v1028031,
            safe_cast(v1028032 as float64) v1028032,
            safe_cast(v1028033 as float64) v1028033,
            safe_cast(v1028034 as float64) v1028034,
            safe_cast(v1028035 as float64) v1028035,
            safe_cast(v1028036 as float64) v1028036,
            safe_cast(v1028037 as float64) v1028037,
            safe_cast(v1028038 as float64) v1028038,
            safe_cast(v1028039 as float64) v1028039,
            safe_cast(v1028040 as float64) v1028040,
            safe_cast(v1028041 as float64) v1028041,
            safe_cast(v1028042 as float64) v1028042,
            safe_cast(v1028043 as float64) v1028043,
            safe_cast(v1028044 as float64) v1028044,
            safe_cast(v1028045 as float64) v1028045,
            safe_cast(v1028046 as float64) v1028046,
            safe_cast(v1028047 as float64) v1028047,
            safe_cast(v1028048 as float64) v1028048,
            safe_cast(v1028049 as float64) v1028049,
            safe_cast(v1028050 as float64) v1028050,
            safe_cast(v1028051 as float64) v1028051,
            safe_cast(v1028052 as float64) v1028052,
            safe_cast(v1028053 as float64) v1028053,
            safe_cast(v1028054 as float64) v1028054,
            safe_cast(v1028055 as float64) v1028055,
            safe_cast(v1028056 as float64) v1028056,
            safe_cast(v1028057 as float64) v1028057,
            safe_cast(v1028058 as float64) v1028058,
            safe_cast(v1028059 as float64) v1028059,
            safe_cast(v1028060 as float64) v1028060,
            safe_cast(v1028061 as float64) v1028061,
            safe_cast(v1028062 as float64) v1028062,
            safe_cast(v1028063 as float64) v1028063,
            safe_cast(v1028064 as float64) v1028064,
            safe_cast(v1028065 as float64) v1028065,
            safe_cast(v1028066 as float64) v1028066,
            safe_cast(v1028067 as float64) v1028067,
            safe_cast(v1028068 as float64) v1028068,
            safe_cast(v1028069 as float64) v1028069,
            safe_cast(v1028070 as float64) v1028070,
            safe_cast(v1028071 as float64) v1028071,
            safe_cast(v1028072 as float64) v1028072,
            safe_cast(v1028073 as float64) v1028073,
            safe_cast(v1028074 as float64) v1028074,
            safe_cast(v1028075 as float64) v1028075,
            safe_cast(v1028076 as float64) v1028076,
            safe_cast(v1028077 as float64) v1028077,
            safe_cast(v1028078 as float64) v1028078,
            safe_cast(v1028079 as float64) v1028079,
            safe_cast(v1028080 as float64) v1028080,
            safe_cast(v1028081 as float64) v1028081,
            safe_cast(v1028082 as float64) v1028082,
            safe_cast(v1028083 as float64) v1028083,
            safe_cast(v1028084 as float64) v1028084,
            safe_cast(v1028085 as float64) v1028085,
            safe_cast(v1028086 as float64) v1028086,
            safe_cast(v1028087 as float64) v1028087,
            safe_cast(v1028088 as float64) v1028088,
            safe_cast(v1028089 as float64) v1028089,
            safe_cast(v1028090 as float64) v1028090,
            safe_cast(v1028091 as float64) v1028091,
            safe_cast(v1028092 as float64) v1028092,
            safe_cast(v1028093 as float64) v1028093,
            safe_cast(v1028094 as float64) v1028094,
            safe_cast(v1028095 as float64) v1028095,
            safe_cast(v1028096 as float64) v1028096,
            safe_cast(v1028097 as float64) v1028097,
            safe_cast(v1028098 as float64) v1028098,
            safe_cast(v1028099 as float64) v1028099,
            safe_cast(v1028100 as float64) v1028100,
            safe_cast(v1028101 as float64) v1028101,
            safe_cast(v1028102 as float64) v1028102,
            safe_cast(v1028103 as float64) v1028103,
            safe_cast(v1028104 as float64) v1028104,
            safe_cast(v1028105 as float64) v1028105,
            safe_cast(v1028106 as float64) v1028106,
            safe_cast(v1028107 as float64) v1028107,
            safe_cast(v1028108 as float64) v1028108,
            safe_cast(v1028109 as float64) v1028109,
            safe_cast(v1028110 as float64) v1028110,
            safe_cast(v1028111 as float64) v1028111,
            safe_cast(v1028112 as float64) v1028112,
            safe_cast(v1028113 as float64) v1028113,
            safe_cast(v1028114 as float64) v1028114,
            safe_cast(v1028115 as float64) v1028115,
            safe_cast(v1028116 as float64) v1028116,
            safe_cast(v1028117 as float64) v1028117,
            safe_cast(v1028118 as float64) v1028118,
            safe_cast(v1028119 as float64) v1028119,
            safe_cast(v1028120 as float64) v1028120,
            safe_cast(v1028121 as float64) v1028121,
            safe_cast(v1028122 as float64) v1028122,
            safe_cast(v1028123 as float64) v1028123,
            safe_cast(v1028124 as float64) v1028124,
            safe_cast(v1028125 as float64) v1028125,
            safe_cast(v1028126 as float64) v1028126,
            safe_cast(v1028127 as float64) v1028127,
            safe_cast(v1028128 as float64) v1028128,
            safe_cast(v1028129 as float64) v1028129,
            safe_cast(v1028130 as float64) v1028130,
            safe_cast(v1028131 as float64) v1028131,
            safe_cast(v1028132 as float64) v1028132,
            safe_cast(v1028133 as float64) v1028133,
            safe_cast(v1028134 as float64) v1028134,
            safe_cast(v1028135 as float64) v1028135,
            safe_cast(v1028136 as float64) v1028136,
            safe_cast(v1028137 as float64) v1028137,
            safe_cast(v1028138 as float64) v1028138,
            safe_cast(v1028139 as float64) v1028139,
            safe_cast(v1028140 as float64) v1028140,
            safe_cast(v1028141 as float64) v1028141,
            safe_cast(v1028142 as float64) v1028142,
            safe_cast(v1028143 as float64) v1028143,
            safe_cast(v1028144 as float64) v1028144,
            safe_cast(v1028145 as float64) v1028145,
            safe_cast(v1028146 as float64) v1028146,
            safe_cast(v1028147 as float64) v1028147,
            safe_cast(v1028148 as float64) v1028148,
            safe_cast(v1028149 as float64) v1028149,
            safe_cast(v1028150 as float64) v1028150,
            safe_cast(v1028151 as float64) v1028151,
            safe_cast(v1028152 as float64) v1028152,
            safe_cast(v1028153 as float64) v1028153,
            safe_cast(v1028154 as float64) v1028154,
            safe_cast(v1028155 as float64) v1028155,
            safe_cast(v1028156 as float64) v1028156,
            safe_cast(v1028157 as float64) v1028157,
            safe_cast(v1028158 as float64) v1028158,
            safe_cast(v1028159 as float64) v1028159,
            safe_cast(v1028160 as float64) v1028160,
            safe_cast(v1028161 as float64) v1028161,
            safe_cast(v1028162 as float64) v1028162,
            safe_cast(v1028163 as float64) v1028163,
            safe_cast(v1028164 as float64) v1028164,
            safe_cast(v1028165 as float64) v1028165,
            safe_cast(v1028166 as float64) v1028166,
            safe_cast(v1028167 as float64) v1028167,
            safe_cast(v1028168 as float64) v1028168,
            safe_cast(v1028169 as float64) v1028169,
            safe_cast(v1028170 as float64) v1028170,
            safe_cast(v1028171 as float64) v1028171,
            safe_cast(v1028172 as float64) v1028172,
            safe_cast(v1028173 as float64) v1028173,
            safe_cast(v1028174 as float64) v1028174,
            safe_cast(v1028175 as float64) v1028175,
            safe_cast(v1028176 as float64) v1028176,
            safe_cast(v1028177 as float64) v1028177,
            safe_cast(v1028178 as float64) v1028178,
            safe_cast(v1028179 as float64) v1028179,
            safe_cast(v1028180 as float64) v1028180,
            safe_cast(v1028181 as float64) v1028181,
            safe_cast(v1028182 as float64) v1028182,
            safe_cast(v1028183 as float64) v1028183,
            safe_cast(v1028184 as float64) v1028184,
            safe_cast(v1028185 as float64) v1028185,
            safe_cast(v1028186 as float64) v1028186,
            safe_cast(v1028187 as float64) v1028187,
            safe_cast(v1028188 as float64) v1028188,
            safe_cast(v1028189 as float64) v1028189,
            safe_cast(v1028190 as float64) v1028190,
            safe_cast(v1028191 as float64) v1028191,
            safe_cast(v1028192 as float64) v1028192,
            safe_cast(v1028193 as float64) v1028193,
            safe_cast(v1028194 as float64) v1028194,
            safe_cast(v1028195 as float64) v1028195,
            safe_cast(v1028196 as float64) v1028196,
            safe_cast(v1028197 as float64) v1028197,
            safe_cast(v1028198 as float64) v1028198,
            safe_cast(v1028199 as float64) v1028199,
            safe_cast(v1028200 as float64) v1028200,
            safe_cast(habitual as float64) habitual,
            safe_cast(efetivo as float64) efetivo
        from {{ set_datalake_project("br_ibge_pnadc_staging.microdados") }} as t
    )
-- verifica se a coluna é do tipo STRING e, caso seja, limpa as observações que
-- começam com 0 (ie. transforma '05' em '5')
select
    {% for column in columns %}
        {% if column.data_type == "STRING" and column.name.startswith("V") %}
            (
                case
                    when
                        length(trim(`{{ column.name }}`)) > 1
                        and left(trim(`{{ column.name }}`), 1) = '0'
                    then substr(trim(`{{ column.name }}`), 2)
                    else trim(`{{ column.name }}`)
                end
            ) as `{{ column.name }}`,
            {{
                log(
                    "Column is of type STRING and starts with V: " ~ column.name,
                    info=true,
                )
            }}
        {% else %}
            `{{ column.name }}`,
            {{
                log(
                    "Column is of type not STRING and does not start with V: "
                    ~ column.name,
                    info=true,
                )
            }}
        {% endif %}
    {% endfor %}
from microdados
